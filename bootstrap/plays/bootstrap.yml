---
- name: bootstrap
  hosts: localhost
  vars_prompt:
    - name: hostname
      prompt: "Enter hostname"
      private: no

  tasks:
    - include_tasks: "bootstrap-{{ os }}.yml"

    - name: setup dot files
      include_role:
        name: dotfiles

    - name: fix checkout to be authenticated
      include_role:
        name: dotfiles
        tasks_from: set-origin

    - name: load roles
      slurp:
        src: "{{ ansible_env.HOME }}/.dotfiles/zsh/hosts/{{ hostname }}.roles"
      register: roles_data

    - set_fact:
        roles: "{{ roles_data.content | b64decode }}"

    - name: apply roles setup 
      tasks:
        - stat:
            path: "{{ ansible_env.HOME }}/.dotfiles/bootstrap/roles/{{ item }}"
          register: role_file
        - include_role:
            name: "{{ item }}"
          when: role_file.stat.exists

      with_items: "{{ roles.split('\n') }}"

    - include_tasks: "load-{{ os }}.yml"
        


